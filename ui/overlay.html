<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Key Queue Overlay</title>
	<link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" href="/static/overlay.css">
	<style>
		:root {
			--bg: rgba(0,0,0,0.0);
			--chip-bg: rgba(0,0,0,0.6);
			--chip-fg: #fff;
			--chip-gap: 8px;
			--chip-pad-v: 10px;
			--chip-pad-h: 14px;
			--chip-radius: 10px;
			--chip-font: 24px;
			--chip-font-weight: 700;
			--fade-in: 120ms;
			--fade-out: 120ms;
			--cols: 8;
			--rows: 1;
			--single-scale: 1;
			--align: center; /* start|center|end (grid physical) */
		}
		html, body { margin: 0; background: var(--bg); }
		#root { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
		.container { width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; }
		.queue-wrap { width: 90vw; max-width: 96vw; }
		.queue {
			display: grid;
			grid-template-columns: repeat(var(--cols), max-content);
			grid-auto-rows: max-content;
			gap: var(--chip-gap);
			justify-content: var(--align);
		}
		.chip {
			background: var(--chip-bg);
			color: var(--chip-fg);
			padding: calc(var(--chip-pad-v) * var(--single-scale)) calc(var(--chip-pad-h) * var(--single-scale));
			border-radius: calc(var(--chip-radius) * var(--single-scale));
			font-size: calc(var(--chip-font) * var(--single-scale));
			font-weight: var(--chip-font-weight);
			font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
			min-width: 44px; text-align: center; user-select: none; transform: translateY(0);
			transition: transform var(--fade-in) ease, opacity var(--fade-in) ease;
		}
		.chip.hide { opacity: 0; transform: translateY(8px); transition: transform var(--fade-out) ease, opacity var(--fade-out) ease; }
	</style>
</head>
<body>
	<div id="root">
		<div class="container">
			<div class="queue-wrap"><div class="queue" id="queue"></div></div>
		</div>
	</div>
	<script>
	(function(){
		const queueEl = document.getElementById('queue');
		const wrapEl = document.querySelector('.queue-wrap');
		let ws; let lastKeys = []; let overlayCfg = null;

		function applyOverlayConfig(cfg){
			if (!cfg) return; overlayCfg = cfg; const root = document.documentElement;
			if (cfg.background) root.style.setProperty('--bg', cfg.background);
			if (cfg.chip_bg) root.style.setProperty('--chip-bg', cfg.chip_bg);
			if (cfg.chip_fg) root.style.setProperty('--chip-fg', cfg.chip_fg);
			['chip_gap','chip_pad_v','chip_pad_h','chip_radius','chip_font_px','chip_font_weight','fade_in_ms','fade_out_ms'].forEach(k=>{
				const map = {chip_gap:'--chip-gap',chip_pad_v:'--chip-pad-v',chip_pad_h:'--chip-pad-h',chip_radius:'--chip-radius',chip_font_px:'--chip-font',chip_font_weight:'--chip-font-weight',fade_in_ms:'--fade-in',fade_out_ms:'--fade-out'};
				const v = cfg[k]; if (typeof v === 'number') root.style.setProperty(map[k], (k.includes('ms')? v+'ms' : v+'px'));
			});
			if (typeof cfg.cols === 'number') root.style.setProperty('--cols', String(cfg.cols));
			if (typeof cfg.rows === 'number') root.style.setProperty('--rows', String(cfg.rows));
			const alignMap = { left: 'start', center: 'center', right: 'end' };
			root.style.setProperty('--align', alignMap[cfg.align] || 'center');
		}

		async function initConfig(){ try{ const res = await fetch('/api/overlay-config'); applyOverlayConfig(await res.json()); }catch(e){} }

		function placeChips(keys){
			queueEl.innerHTML = '';
			const cols = Number(overlayCfg?.cols ?? 8); const rows = Number(overlayCfg?.rows ?? 1);
			let toShow = keys;
			if (rows > 0){ const capacity = Math.max(1, cols * rows); toShow = keys.slice(Math.max(0, keys.length - capacity)); }
			if (overlayCfg?.direction === 'rtl') toShow = Array.from(toShow).reverse();
			toShow.forEach(k => { const chip = document.createElement('div'); chip.className = 'chip'; chip.dataset.key = k; chip.textContent = k; queueEl.appendChild(chip); });
		}

		function connect(){
			const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws'; ws = new WebSocket(url);
			ws.onmessage = (ev) => { try { const data = JSON.parse(ev.data); if (data.type === 'config' && data.overlay){ applyOverlayConfig(data.overlay); return; } if (Array.isArray(data.keys)) { lastKeys = data.keys; placeChips(lastKeys); } } catch(e){} };
			ws.onclose = () => { setTimeout(connect, 1000); };
		}

		initConfig(); connect();
	})();
	</script>
</body>
</html>