<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyQueueViewer</title>
    <link rel="stylesheet" href="launcher.css">
</head>
<body>
    <div class="container">
        <h1 data-i18n="app_title">KeyQueueViewer</h1>

        <!-- Settings Section -->
        <div class="section">
            <div class="section-title" data-i18n="settings">Settings</div>
            
            <div class="form-row">
                <label for="language" data-i18n="language">언어:</label>
                <select id="language">
                    <option value="ko">한국어</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div class="form-row">
                <label for="port" data-i18n="port">포트:</label>
                <input type="number" id="port" value="8000" min="1024" max="65535">
                <button id="port-save" data-i18n="port_save">포트 저장</button>
            </div>
            <div class="port-warning" style="margin-top:8px; padding:10px 12px; background:#ff475722; border:1px solid #ff4757; border-radius:6px; font-size:12px; line-height:1.5;">
                <strong style="color:#ff4757;">⚠️ <span data-i18n="port_warning_title">중요</span></strong><br>
                <span data-i18n="port_warning_text">포트를 변경하면 저장된 설정(localStorage, Cookie)이 초기화됩니다. 변경 전 설정을 내보내기하세요!</span>
            </div>
        </div>

        <!-- Server Status Section -->
        <div class="section">
            <div class="section-title" data-i18n="server_status">Server status:</div>
            
            <div class="status">
                <span class="status-text" id="status-text" data-i18n="server_stopped">서버가 중지되었습니다</span>
                <div class="status-indicator" id="status-indicator"></div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="btn-start" data-i18n="start_server">서버 시작</button>
                <button class="btn btn-danger" id="btn-stop" disabled data-i18n="stop_server">서버 중지</button>
            </div>
        </div>

        <!-- Options Section -->
        <div class="section">
            <div class="checkbox-row">
                <input type="checkbox" id="run-on-boot">
                <label for="run-on-boot" data-i18n="console_toggle">콘솔 토글</label>
            </div>

            <div class="checkbox-row">
                <input type="checkbox" id="run-on-startup">
                <label for="run-on-startup" data-i18n="run_on_startup">Windows 시작 시 실행</label>
            </div>
        </div>

        <!-- Action Buttons Section -->
        <div class="section">
            <div class="button-group">
                <button class="btn-secondary" id="btn-control" disabled data-i18n="web_control">웹 제어</button>
                <button class="btn-secondary" id="btn-overlay" disabled data-i18n="overlay">오버레이</button>
            </div>
        </div>

        <div class="button-group" style="margin-top: 8px;">
            <button class="btn-secondary" id="btn-minimize" data-i18n="minimize_to_tray">트레이로 최소화</button>
            <button class="btn-secondary" id="btn-reset-settings" data-i18n="reset_settings">설정 초기화</button>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <p data-i18n="info_1">1. 원하는 지원할 시작하세요</p>
            <p data-i18n="info_2">2. 시작하면 열면, 대상 창을 설정하세요</p>
            <p data-i18n="info_3">3. OBS 스트림칭 소 소비지서 오버레이를 띄워요</p>
            <p><span data-i18n="info_4">4. URL은 다음으로</span> : <a href="#" class="url-link" id="overlay-url">http://localhost:8000/overlay</a></p>
            <p data-i18n="info_note" style="color: #ff9800; font-size: 11px; margin-top: 8px; line-height: 1.7; font-weight: 500;">※ 주의: 사용자 지정 CSS를 비우고 사이트에서 보이나 OBS에서 안 보이는 경우 현재 페이지의 캐시 버튼을 눌러 새로고침 해주세요.</p>
        </div>
    </div>

    <script>
        // Direct IPC for Tauri 2.0
        async function invoke(cmd, args = {}) {
            if (window.__TAURI__ && window.__TAURI__.core && window.__TAURI__.core.invoke) {
                return window.__TAURI__.core.invoke(cmd, args);
            }
            throw new Error('Tauri API not available');
        }

        // Tauri API wrapper with retry logic  
        function waitForTauri(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkTauri = () => {
                attempts++;
                console.log(`Checking Tauri API... Attempt ${attempts}`);
                
                if (window.__TAURI__) {
                    console.log('✓ Tauri API loaded successfully!');
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(checkTauri, 100);
                } else {
                    console.error('✗ Failed to load Tauri API after ' + maxAttempts + ' attempts');
                    document.body.innerHTML = '<div style="padding: 20px;"><h2 style="color: red;">Error: Tauri API Failed to Load</h2><p>Please restart the application.</p><p>If the problem persists, please reinstall the application.</p></div>';
                }
            };
            checkTauri();
        }
        
        // Wait for both DOM and Tauri
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                waitForTauri(initApp);
            });
        } else {
            waitForTauri(initApp);
        }
        
        async function initApp() {
        console.log('Initializing app...');
        
        // Use direct invoke if __TAURI__ not available
        if (!window.invoke) {
            window.invoke = async (cmd, args = {}) => {
                return window.__TAURI_INVOKE__(cmd, args);
            };
        }
        
        // Check macOS permissions - redirect if not all granted
        try {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            if (isMac) {
                const perms = await window.__TAURI__.core.invoke('check_macos_permissions');
                console.log('macOS permissions:', perms);
                const allGranted = perms.accessibility && perms.input_monitoring && perms.screen_recording;
                if (!allGranted) {
                    console.log('Not all permissions granted, redirecting to permissions page...');
                    window.location.href = 'permissions.html';
                    return;
                }
            }
        } catch (e) {
            console.log('Permission check failed (may not be macOS):', e);
        }
        
        let serverRunning = false;
        let currentPort = 8000;
        let currentLanguage = 'ko';

        // Translations
        const translations = {
            ko: {
                app_title: 'KeyQueueViewer',
                settings: 'Settings',
                language: '언어:',
                port: '포트:',
                port_save: '포트 저장',
                port_warning_title: '중요',
                port_warning_text: '포트를 변경하면 저장된 설정(localStorage, Cookie)이 초기화됩니다. 변경 전 설정을 내보내기하세요!',
                server_status: 'Server status:',
                server_running: '서버가 실행 중입니다',
                server_stopped: '서버가 중지되었습니다',
                start_server: '서버 시작',
                stop_server: '서버 중지',
                console_toggle: '콘솔 토글',
                run_on_startup: 'Windows 시작 시 실행',
                web_control: '웹 제어',
                overlay: '오버레이',
                minimize_to_tray: '트레이로 최소화',
                reset_settings: '설정 초기화',
                info_1: '1. 서버를 시작하세요',
                info_2: '2. 서버를 시작하면 열면, 대상 창을 설정하세요',
                info_3: '3. OBS 소스 목록에서 브라우저를 추가하세요',
                info_4: '4. 브라우저 소스의 URL을 오른쪽 링크로 적용하세요',
                info_note: '※ 주의: 사용자 지정 CSS를 비우고 사이트에서 보이나 OBS에서 안 보이는 경우 현재 페이지의 캐시 버튼을 눌러 새로고침 해주세요.'
            },
            en: {
                app_title: 'Key Queue Viewer',
                settings: 'Settings',
                language: 'Language:',
                port: 'Port:',
                port_save: 'Save Port',
                port_warning_title: 'Important',
                port_warning_text: 'Changing the port will reset saved settings (localStorage, Cookie). Export your settings before changing!',
                server_status: 'Server status:',
                server_running: 'Server is running',
                server_stopped: 'Server is stopped',
                start_server: 'Start Server',
                stop_server: 'Stop Server',
                console_toggle: 'Console Toggle',
                run_on_startup: 'Run on Windows startup',
                web_control: 'Web Control',
                overlay: 'Overlay',
                minimize_to_tray: 'Minimize to Tray',
                reset_settings: 'Reset Settings',
                info_1: '1. Start the server you want',
                info_2: '2. Once started, set the target window',
                info_3: '3. Display the overlay in OBS streaming software',
                info_4: '4. Apply the URL of the browser source to the right link',
                info_note: '※ Note: If the overlay is visible in the URL but not in OBS after clearing custom CSS, please click the cache button on the current page to refresh.'
            }
        };

        // UI Elements
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const btnControl = document.getElementById('btn-control');
        const btnOverlay = document.getElementById('btn-overlay');
        const btnMinimize = document.getElementById('btn-minimize');
        const btnPortSave = document.getElementById('port-save');
        const btnResetSettings = document.getElementById('btn-reset-settings');
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('status-indicator');
        const portInput = document.getElementById('port');
        const languageSelect = document.getElementById('language');
        const consoleToggle = document.getElementById('run-on-boot');
        const runOnStartup = document.getElementById('run-on-startup');
        const overlayUrl = document.getElementById('overlay-url');

        // Apply translations
        function applyTranslations(lang) {
            const t = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // Update status text based on current state
            if (serverRunning) {
                statusText.textContent = t.server_running;
            } else {
                statusText.textContent = t.server_stopped;
            }
        }

        // Update UI based on server status
        function updateUI() {
            const t = translations[currentLanguage];
            
            if (serverRunning) {
                statusText.textContent = t.server_running;
                statusIndicator.classList.add('running');
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnControl.disabled = false;
                btnOverlay.disabled = false;
                portInput.disabled = true;
                btnPortSave.disabled = true;
            } else {
                statusText.textContent = t.server_stopped;
                statusIndicator.classList.remove('running');
                btnStart.disabled = false;
                btnStop.disabled = true;
                btnControl.disabled = true;
                btnOverlay.disabled = true;
                portInput.disabled = false;
                btnPortSave.disabled = false;
            }
            overlayUrl.textContent = `http://localhost:${currentPort}/overlay`;
            overlayUrl.href = `http://localhost:${currentPort}/overlay`;
        }

        // Load settings from backend
        async function loadSettings() {
            try {
                const settings = await invoke('get_launcher_settings');
                console.log('Loaded settings:', settings);
                
                portInput.value = settings.port || 8000;
                currentPort = settings.port || 8000;
                currentLanguage = settings.language || 'ko';
                languageSelect.value = currentLanguage;
                runOnStartup.checked = settings.run_on_startup || false;
                
                // Apply language
                applyTranslations(currentLanguage);
                
                // Check if server is already running
                const status = await invoke('get_server_status');
                console.log('Server status:', status);
                serverRunning = status.running;
                updateUI();
            } catch (error) {
                console.error('Failed to load settings:', error);
                // Set defaults on error
                serverRunning = false;
                updateUI();
            }
        }

        function formatPortProcessList(processes) {
            return processes
                .map((p) => `PID ${p.pid} (${p.name || 'Unknown'})`)
                .join('\n');
        }

        async function resolvePortConflictIfNeeded(port) {
            let processes = [];
            try {
                processes = await invoke('get_port_processes', { port });
            } catch (error) {
                console.warn('Port process lookup not available:', error);
                return true;
            }

            if (!Array.isArray(processes) || processes.length === 0) {
                return true;
            }

            const listText = formatPortProcessList(processes);
            const confirmMsg = currentLanguage === 'ko'
                ? `포트 ${port}를 사용 중인 프로세스가 있습니다.\n\n${listText}\n\n이 프로세스를 종료하고 서버를 시작할까요?`
                : `Processes are already using port ${port}.\n\n${listText}\n\nTerminate them and start the server?`;
            if (!confirm(confirmMsg)) {
                return false;
            }

            for (const proc of processes) {
                try {
                    await invoke('kill_process', { pid: proc.pid });
                } catch (error) {
                    const msg = currentLanguage === 'ko'
                        ? `PID ${proc.pid} 종료 실패: ${error}`
                        : `Failed to terminate PID ${proc.pid}: ${error}`;
                    alert(msg);
                    return false;
                }
            }
            return true;
        }

        // Save port setting (saved to Windows Registry)
        btnPortSave.addEventListener('click', async () => {
            const port = parseInt(portInput.value);
            if (port < 1024 || port > 65535) {
                const msg = currentLanguage === 'ko' 
                    ? '포트는 1024-65535 사이여야 합니다.' 
                    : 'Port must be between 1024-65535.';
                alert(msg);
                return;
            }
            
            try {
                await invoke('save_port_setting', { port });
                currentPort = port;
                updateUI();
                const msg = currentLanguage === 'ko' 
                    ? '포트가 저장되었습니다!' 
                    : 'Port saved!';
                alert(msg);
            } catch (error) {
                console.error('Failed to save port:', error);
                const msg = currentLanguage === 'ko' 
                    ? '포트 저장 실패: ' + error 
                    : 'Failed to save port: ' + error;
                alert(msg);
            }
        });

        // Start server
        btnStart.addEventListener('click', async () => {
            console.log('Starting server on port:', currentPort);
            try {
                const canStart = await resolvePortConflictIfNeeded(currentPort);
                if (!canStart) return;

                await invoke('start_server', { port: currentPort });
                serverRunning = true;
                updateUI();
                console.log('Server started successfully');
            } catch (error) {
                console.error('Failed to start server:', error);
                // Display detailed error message (includes port conflict info)
                const errorMsg = String(error);
                alert(errorMsg);
            }
        });

        // Stop server
        btnStop.addEventListener('click', async () => {
            console.log('Stopping server');
            try {
                await invoke('stop_server');
                serverRunning = false;
                updateUI();
                console.log('Server stopped successfully');
            } catch (error) {
                console.error('Failed to stop server:', error);
                alert('Failed to stop server: ' + error);
            }
        });

        // Open control page
        btnControl.addEventListener('click', () => {
            console.log('Opening control page');
            invoke('open_url', { url: `http://localhost:${currentPort}/control` });
        });

        // Open overlay page
        btnOverlay.addEventListener('click', () => {
            console.log('Opening overlay page');
            invoke('open_url', { url: `http://localhost:${currentPort}/overlay` });
        });

        // Minimize to tray
        btnMinimize.addEventListener('click', async () => {
            try {
                await invoke('minimize_to_tray');
            } catch (error) {
                console.error('Failed to minimize to tray:', error);
            }
        });

        // Language change (saved to Windows Registry)
        languageSelect.addEventListener('change', async (e) => {
            currentLanguage = e.target.value;
            try {
                await invoke('save_language_setting', { language: currentLanguage });
                applyTranslations(currentLanguage);
            } catch (error) {
                console.error('Failed to save language:', error);
            }
        });

        // Run on startup change (saved to Windows Registry)
        runOnStartup.addEventListener('change', async (e) => {
            try {
                await invoke('set_run_on_startup', { enabled: e.target.checked });
            } catch (error) {
                alert('Failed to set startup option: ' + error);
                e.target.checked = !e.target.checked;
            }
        });

        // Console toggle (immediate show/hide on Windows)
        consoleToggle.addEventListener('change', async (e) => {
            try {
                await invoke('set_console_visible', { visible: e.target.checked });
            } catch (error) {
                alert('Failed to toggle console: ' + error);
                e.target.checked = !e.target.checked;
            }
        });

        // Reset settings button
        btnResetSettings.addEventListener('click', async () => {
            const t = translations[currentLanguage];
            const confirmMsg = currentLanguage === 'ko' 
                ? '모든 설정을 초기화하시겠습니까?\n(포트, 언어, 자동 시작, 대상 창, 오버레이 설정)\n앱이 종료됩니다.'
                : 'Reset all settings?\n(Port, Language, Auto-start, Target window, Overlay config)\nThe app will close.';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                await invoke('reset_settings');
                const successMsg = currentLanguage === 'ko' 
                    ? '설정이 초기화되었습니다. 앱을 종료합니다.'
                    : 'Settings reset successfully. Closing app.';
                alert(successMsg);
                // Close the app
                window.close();
            } catch (error) {
                console.error('Failed to reset settings:', error);
                const errorMsg = currentLanguage === 'ko' 
                    ? '설정 초기화 실패: ' + error
                    : 'Failed to reset settings: ' + error;
                alert(errorMsg);
            }
        });

        // Overlay URL click
        overlayUrl.addEventListener('click', (e) => {
            e.preventDefault();
            invoke('open_url', { url: overlayUrl.href });
        });

        // Initialize
        console.log('Initializing launcher...');
        loadSettings();
        } // end of initApp
    </script>
</body>
</html>
