name: Test and build

on:
  push:
    branches: [main, master]
    paths:
      - "src-tauri/**"
      - "ui/**"
      - ".cargo/config.toml"
      - ".github/workflows/test.yml"
      - "check-all.sh"
      - "check-all.ps1"
  pull_request:
    branches: [main, master]
    paths:
      - "src-tauri/**"
      - "ui/**"
      - ".cargo/config.toml"
      - ".github/workflows/test.yml"
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Read version from Cargo.toml
        id: version
        run: |
          version=$(grep -m1 '^version\s*=' src-tauri/Cargo.toml | sed -E 's/version\s*=\s*"([^"]+)"/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Version: $version"

  fmt-clippy-test-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> dist'
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libx11-dev \
            libxdo-dev \
            libxcb1-dev
      - name: fmt
        run: cargo kfmt
      - name: clippy
        run: cargo kclippy
      - name: test
        run: cargo ktest

  build-windows-portable:
    needs: [prepare, fmt-clippy-test-linux]
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> dist'
      - name: Build release binary
        run: cargo kb --release
      - name: Package portable files
        shell: pwsh
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          New-Item -ItemType Directory -Force -Path "dist/release" | Out-Null
          Copy-Item "dist/release/KBQV.exe" "dist/release/KBQV-$version-windows-x64.exe" -Force
          Compress-Archive -Path "dist/release/KBQV.exe" -DestinationPath "dist/release/KBQV-$version-windows-x64.zip" -Force
      - name: Upload windows portable artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable-${{ needs.prepare.outputs.version }}
          path: |
            dist/release/KBQV-*.exe
            dist/release/KBQV-*.zip

  build-linux-portable:
    needs: [prepare, fmt-clippy-test-linux]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> dist'
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libx11-dev \
            libxdo-dev \
            libxcb1-dev
      - name: Build release binary
        run: cargo kb --release
      - name: Package portable files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist/release
          cp "dist/release/KBQV" "dist/release/KBQV-$VERSION-linux-x64"
          tar -czf "dist/release/KBQV-$VERSION-linux-x64.tar.gz" -C dist/release "KBQV-$VERSION-linux-x64"
      - name: Upload linux portable artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-portable-${{ needs.prepare.outputs.version }}
          path: |
            dist/release/KBQV-*-linux-x64
            dist/release/KBQV-*-linux-x64.tar.gz

  build-macos-portable:
    needs: [prepare, fmt-clippy-test-linux]
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> dist'
      - name: Build release binary
        run: cargo kb --release
      - name: Package portable files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then ARCH_TAG="x64"; else ARCH_TAG="arm64"; fi
          mkdir -p dist/release
          cp "dist/release/KBQV" "dist/release/KBQV-$VERSION-macos-$ARCH_TAG"
          ditto -c -k "dist/release/KBQV-$VERSION-macos-$ARCH_TAG" "dist/release/KBQV-$VERSION-macos-$ARCH_TAG.zip"
      - name: Upload macOS portable artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: macos-portable-${{ needs.prepare.outputs.version }}
          path: |
            dist/release/KBQV-*-macos-*
            dist/release/KBQV-*-macos-*.zip
