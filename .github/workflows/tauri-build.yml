name: Tauri Release

on:
  workflow_run:
    workflows: ["Test and build"]
    types: [completed]
  workflow_dispatch:

jobs:
  release:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (
        github.event.workflow_run.conclusion == 'success' &&
        (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 0

      - name: Read version from Cargo.toml
        id: version
        run: |
          version=$(grep -m1 '^version\s*=' src-tauri/Cargo.toml | sed -E 's/version\s*=\s*"([^"]+)"/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Version: $version"

      - name: Download artifacts from Test and build
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          path: ./artifacts
          if_no_artifact_found: warn

      - name: Download artifacts (manual run fallback)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
        continue-on-error: true

      - name: Build checklist
        id: check_builds
        run: |
          echo "Checking downloaded artifacts..."
          ls -R ./artifacts || echo "No artifacts directory"

          checklist=""

          if compgen -G "./artifacts/windows-portable-*/*" > /dev/null; then
            checklist="${checklist}- [OK] Windows Portable\n"
          else
            checklist="${checklist}- [FAIL] Windows Portable\n"
          fi

          if compgen -G "./artifacts/linux-portable-*/*" > /dev/null; then
            checklist="${checklist}- [OK] Linux Portable\n"
          else
            checklist="${checklist}- [FAIL] Linux Portable\n"
          fi

          if compgen -G "./artifacts/macos-portable-*/*" > /dev/null; then
            checklist="${checklist}- [OK] macOS Portable\n"
          else
            checklist="${checklist}- [FAIL] macOS Portable\n"
          fi

          echo "checklist<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$checklist" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Collect release files
        run: |
          mkdir -p release-files
          find ./artifacts -type f -name "KBQV-*" -exec cp {} ./release-files/ \; || true
          ls -lh ./release-files || true

      - name: Ensure at least one release file exists
        run: |
          if ! ls ./release-files/* >/dev/null 2>&1; then
            echo "No release files found. Skipping release."
            exit 1
          fi

      - name: Generate changelog link
        id: changelog
        run: |
          version="${{ steps.version.outputs.version }}"
          currentTag="v$version"
          previousTag=$(git tag --sort=-version:refname | grep -v "^$currentTag$" | head -n 1 || true)
          if [ -n "$previousTag" ]; then
            echo "full_changelog=**Full Changelog**: https://github.com/${{ github.repository }}/compare/$previousTag...$currentTag" >> "$GITHUB_OUTPUT"
          else
            echo "full_changelog=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create/Update tag
        run: |
          version="${{ steps.version.outputs.version }}"
          tagName="v$version"
          if git tag -l "$tagName" | grep -q "$tagName"; then
            git tag -d "$tagName" || true
            git push origin ":refs/tags/$tagName" || true
          fi
          git tag "$tagName"
          git push origin "$tagName"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: KeyQueueViewer v${{ steps.version.outputs.version }}
          body: |
            Portable builds only:
            - Windows: `KBQV-<version>-windows-x64.exe` or `.zip`
            - Linux: `KBQV-<version>-linux-x64` or `.tar.gz`
            - macOS: `KBQV-<version>-macos-<arch>` or `.zip`

            ### Build Status
            ${{ steps.check_builds.outputs.checklist }}

            ### Changelog
            ${{ steps.changelog.outputs.full_changelog }}
          files: ./release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
